<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Site Properties -->
  <title>光美焕-打印</title>
  <link rel="shortcut icon" type="image/x-icon" href="css/images/favicon.ico">

  <!--JQuery-->
  <script src="js/jquery.min.js"></script>

  <!--Semantic-UI-->
  <link rel="stylesheet" type="text/css" href="css/semantic-ui/semantic.css">
  <script src="css/semantic-ui/semantic.js"></script>

  <!--Style-->
  <link rel="stylesheet" href="css/style.css">
  
  <!--Script-->
  <script src="js/action.js"></script>
  <script src="js/tools.js"></script>
  <script src="js/script.js"></script>
</head>
<body style="font-size:1px !important;">
    <button class="ui blue button fake-button" style="display:none;"></button>
    <div><img  class="print-img" src="css/images/logo-print.png" alt=""></div>
    <div class="print-address"></div>
    <div class="print-phone"></div>
    <div class="print-time"></div>
    <table class="ui very basic compact table">
        <thead>
            <tr>
                <th>项目名</th>
                <th>原价</th>
                <th>实付金额</th>
                <th>操作员</th>
                <th>付款方式</th>
            </tr>
        </thead>
        <tbody class="print-record">
        </tbody>
    </table>
    <div class="print-balance"></div>
    <div class="print-consume-time"></div>
    <script>
        $(document).ready(function(){
            $('.fake-button').api({
            action: 'print record',
            method: 'GET',
            on: 'now',
            beforeXHR: function (xhr) {
                verifyToken();
                xhr.setRequestHeader('X-token', getSessionStorage('token'));
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            },
            beforeSend: function (settings) {
                settings.data.id = getQueryString('recordId');
                return settings;
            },
            onSuccess: function (response) {
                if (response.error != null) {
                    alert(response.error);
                    verifyStatus(response.code);
                } else {
                    console.log(response);
                    $('.print-address').html('地址：'+  response.data.address);
                    $('.print-phone').html('电话：' + response.data.shopPhone);
                    $('.print-time').html('打印时间：' + toDatetimeMin(Date.parse(new Date())));
                    if(response.data.memberVos.length == 0){
                        $('.print-balance').html('非会员' );
                    }else{
                        var str = ''
                        $.each(response.data.memberVos,function(i,data){
                            str += data.memberLevelName + ':<br>美容储值：' + data.beautyMoney + '美容储值：' + data.nailMoney + '<br>';
                        })
                        $('.print-balance').html(str);
                    }
                    
                    var projectNames = [];
                    var employeeNames = [];
                    var retailPrices = [];
                    var charges = [];

                    $.each(response.data.consumeRecordProjectVos,function(i,data){
                        projectNames.push(data.projectName);
                        employeeNames.push(data.employeeName);
                        retailPrices.push(data.retailPrice);
                        charges.push(data.charge);
                    })

                    var $tr = $('<tr></tr>');
                    var $projectName = $('<td class="projectName">' + projectNames.join('<br>') + '</td>');
                    var $employeeName = $('<td class="projectName">' + employeeNames.join('<br>') + '</td>');
                    var $retailPrice = $('<td class="projectName">' + retailPrices.join('<br>') + '</td>');
                    var $charge = $('<td class="projectName">' + charges.join('<br>') + '</td>');

                    if(chargeWay == '会员卡'){
                        var $chargeWay = $('<td class="chargeWay">' + response.data.chargeCard + '</td>');
                    }else{
                        var $chargeWay = $('<td class="chargeWay">' + response.data.chargeWay + '</td>');
                    }

                    $tr.append($projectName);
                    $tr.append($retailPrice);
                    $tr.append($charge);
                    $tr.append($employeeName);
                    $tr.append($chargeWay);
                    $('.print-record').append($tr);
                    window.print();
                }
            },
            onFailure: function (response) {
                alert('服务器开小差了');
            }
            })
            
        })
    </script>
</body>
</html>